<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Mobile Karaoke LRC</title>
<style>
  :root { --pad: 16px; }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    text-align: center;
    display: flex;
    flex-direction: column;
    height: 100vh;
    justify-content: space-between;
    background-image: url('songs/bg.jpg');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  .lyrics {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 12px;
    padding: var(--pad);
  }
  .current-line {
    font-size: 1.6rem;
    font-weight: 700;
    min-height: 3.2rem;
    letter-spacing: 0.2px;
    word-wrap: break-word;
    white-space: normal;
  }
  .next-line {
    opacity: 0.75;
    font-size: 1.1rem;
    min-height: 1.6rem;
  }
  .progress {
    height: 4px;
    background: rgba(255,255,255,0.18);
    border-radius: 999px;
    overflow: hidden;
    margin-top: 4px;
  }
  .progress-bar {
    height: 100%;
    width: 100%;
    transform: scaleX(0);
    transform-origin: left;
    background: rgba(255,255,255,0.9);
    transition: transform 0.08s linear; /* small smoothing */
  }
  .controls { padding: var(--pad); }
  button {
    width: 64px; height: 64px; border-radius: 50%; border: none;
    background: rgba(255,255,255,0.18);
    color: #fff; font-size: 1.5rem; box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    display: inline-flex; align-items: center; justify-content: center;
  }
  button:active { transform: scale(0.98); }
</style>
</head>
<body>
  <div class="lyrics">
    <div class="current-line" id="currentLine"></div>

    <div class="progress" aria-hidden="true">
      <div class="progress-bar" id="lineProgress"></div>
    </div>

    <div class="next-line" id="nextLine"></div>
  </div>

  <div class="controls">
    <button id="playBtn">▶</button>
  </div>

<script>
  const playBtn = document.getElementById('playBtn');
  const currentLineEl = document.getElementById('currentLine');
  const nextLineEl = document.getElementById('nextLine');
  const lineProgressEl = document.getElementById('lineProgress');

  const embeddedLyrics = `
[id: pshliraq]
[ar: Hermes House Band]
[al: The Carnival Album]
[ti: Country Roads]
[length: 03:20]

[00:03.36]Happy birthday, Laura and Signe
[00:06.43]
[00:09.28]You are old
[00:11.58]
[00:15.47]Almost hell bound, Laura and Signe
[00:20.12]Swamps and forests, close to Frederiks castle
[00:24.82]Growing older, older than the trees
[00:29.17]Young and blissful moments, going with the breeze
[00:33.46]You are old, but youre gold
[00:38.24]Looking like castle walls
[00:42.86]Danish flowers, flatland mammas
[00:47.91]You are old, but youre gold
[00:53.96]All youre memories disappearing
[00:58.68]Youth so distant, can’t be emigrating
[01:03.26]Dark and dusty, clothes and skin and hair
[01:07.55]Misty taste of tuborg, teardrops in my eye
[01:11.73]You are old, but youre gold
[01:16.45]Looking like castle walls
[01:21.30]Danish flowers, flatland mammas
[01:26.28]You are old, but youre gold
[01:31.84]We hear your voice in the morning like a saw mill
[01:36.39]Radio reminds us of your sweet sixteen
[01:41.13]Blond and dark red hair, I get a feeling that I
[01:44.78]Should have been home yesterday, yesterday
[01:51.21]You are old, but you’re gold (You are gold)
[01:58.06]Looking like castle walls (Happy birthday)
[02:03.95]Danish flowers, not yet mammas
[02:09.47]You are old, but you’re gold (Here we go, here we go)
[02:14.32]You are old, but you’re gold
[02:19.15]Looking like castle walls
[02:23.34]Danish flowers, flatland mammas
[02:27.62]You are old, but you’re gold
[02:31.44]Lalala heyhey lalala heyhey lalala heyhey lalala
[02:38.61]Danish flowers, flatland mammas
[02:42.40]You are old, but you’re gold
[02:46.21]Lalala heyhey lalala heyhey lalala heyhey lalala
[02:53.42]Danish flowers, flatland mammas
[02:57.23]You are old, but you’re gold
[03:01.09]You are old, but you’re gold
[03:05.18]You are old, you are old
[03:11.67]
`;

  let lyrics = parseLRC(embeddedLyrics);
  let idx = -1;       // current index shown in UI
  let rafId = null;
  let startTime = null;

  function parseLRC(text) {
    const lines = text.split(/\r?\n/);
    const out = [];
    for (let i = 0; i < lines.length; i++) {
      const m = lines[i].match(/\[(\d{2}):(\d{2}\.\d{2})\](.*)/);
      if (m) {
        const min = parseInt(m[1], 10);
        const sec = parseFloat(m[2]);
        out.push({ time: min * 60 + sec, text: m[3].trim() });
      }
    }
    return out;
  }

  // NEW: non-mutating lookup. Returns index (0..N-1) of the last lyric <= t, or -1 if none.
  function findIndexForTime(t) {
    // simple linear search from end (cheap for short LRCs). This does NOT change idx.
    for (let j = lyrics.length - 1; j >= 0; j--) {
      if (lyrics[j].time <= t) return j;
    }
    return -1;
  }

  // Always update the next-line text so it reliably updates as the current line changes.
  function updateUIForIndex(i) {
    if (i < 0) {
      currentLineEl.textContent = '';
    } else {
      currentLineEl.textContent = lyrics[i]?.text || '';
    }
    // ALWAYS set the next line (empty string if none)
    nextLineEl.textContent = lyrics[i + 1]?.text || '';

    // reset progress for new line
    if (lineProgressEl) lineProgressEl.style.transform = 'scaleX(0)';
  }

  function loop() {
  const t = (Date.now() - startTime) / 1000;
  const i = findIndexForTime(t);

  // Detect new line change (including first line starting)
  if (i !== idx) {
    idx = i;
    updateUIForIndex(i);
  }

  // Handle progress bar:
  if (i >= 0 && lyrics[i]) {
    // We're inside a lyric
    const nextTime = lyrics[i + 1]?.time ?? (lyrics[i].time + 2);
    const duration = Math.max(0.001, nextTime - lyrics[i].time);
    const elapsed = Math.max(0, t - lyrics[i].time);
    const progress = Math.min(1, elapsed / duration);
    if (lineProgressEl) lineProgressEl.style.transform = `scaleX(${progress})`;

  } else {
    // Before the first lyric starts: run progress from 0 → 1 until first lyric time
    const firstLyricTime = lyrics[0]?.time ?? 0;
    const elapsedBefore = Math.max(0, t);
    const progressBefore = Math.min(1, elapsedBefore / firstLyricTime);
    if (lineProgressEl) lineProgressEl.style.transform = `scaleX(${progressBefore})`;
  }

  rafId = requestAnimationFrame(loop);
}


  playBtn.addEventListener('click', () => {
    if (rafId) {
      // Stop / reset
      cancelAnimationFrame(rafId);
      rafId = null;
      idx = -1;
      currentLineEl.textContent = '';
      nextLineEl.textContent = '';
      if (lineProgressEl) lineProgressEl.style.transform = 'scaleX(0)';
      playBtn.textContent = '▶';
    } else {
      // Start from the top (simple start; does not support resume)
      startTime = Date.now();
      idx = -1;
      updateUIForIndex(-1); // preload first upcoming line
      rafId = requestAnimationFrame(loop);
      playBtn.textContent = '⏸';
    }
  });

  // Optionally: expose a function to start at an arbitrary time (useful for testing)
  // function seekTo(seconds) { startTime = Date.now() - seconds * 1000; idx = -1; updateUIForIndex(-1); }

</script>
</body>
</html>

